# Мини-кошелёк для путешественника (Telegram-бот)

Бот ведёт учёт расходов в поездках: несколько путешествий, баланс в двух валютах, история трат. Курсы берутся с **api.exchangerate.host** (используется только этот API). Данные хранятся локально в SQLite.

## Возможности

- **Создание путешествия**: страна отправления и назначения → проверка валют через API → текущий курс → подтверждение или ручной ввод курса → начальная сумма в домашней валюте (конвертируется через API в валюту поездки).
- **Несколько путешествий**: переключение активного кошелька.
- **Расходы**: любое сообщение с числом считается суммой расхода в валюте поездки; бот пересчитывает в домашнюю и предлагает учесть трату (✅ Да / ❌ Нет). Баланс показывается в обеих валютах.
- **Inline-меню**: главное меню и разделы без слэш-команд.
- **Слэш-команды**: `/newtrip`, `/switch`, `/balance`, `/history`, `/setrate`.

## Требования

- Python 3.10+
- Ключ API [exchangerate.host](https://exchangerate.host) (обязателен)
- Токен Telegram-бота от [@BotFather](https://t.me/BotFather)

## Установка и запуск

### 1. Клонирование / переход в каталог проекта

```bash
cd C:\API_5
```

### 2. Создание виртуального окружения (рекомендуется)

```bash
python -m venv venv
venv\Scripts\activate
```

В Linux/macOS:

```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

Будут установлены:

- `pyTelegramBotAPI` — работа с Telegram Bot API
- `requests` — HTTP-запросы к api.exchangerate.host

### 4. Настройка конфигурации

Создайте файл `config.env` в корне проекта (рядом с `bot.py`), по образцу `config.example.env`:

```env
EXCHANGERATE_ACCESS_KEY=ваш_ключ_с_exchangerate.host
TELEGRAM_BOT_TOKEN=токен_от_BotFather
```

- **EXCHANGERATE_ACCESS_KEY** — ключ с [exchangerate.host](https://exchangerate.host) (нужен для конвертации и проверки валют). Бесплатные/тестовые API в проекте не используются.
- **TELEGRAM_BOT_TOKEN** — токен бота из [@BotFather](https://t.me/BotFather).

Файл `config.env` не должен попадать в репозиторий (добавлен в `.gitignore`).

### 5. Запуск бота

```bash
python bot.py
```

При успешном старте в консоли появится сообщение «Бот запущен». После этого бот отвечает в Telegram.

### Остановка

В терминале нажмите `Ctrl+C`.

## Структура проекта

| Файл / каталог      | Назначение |
|---------------------|------------|
| `bot.py`            | Логика бота: команды, inline-меню, FSM создания поездки, учёт расходов |
| `api_client.py`     | Запросы к api.exchangerate.host: `/convert`, `/list`, проверка валют |
| `current_api.py`    | Маппинг страны → валюта, обёртки для конвертации |
| `db.py`             | SQLite: пользователи, путешествия, расходы, состояние (FSM) |
| `config.env`        | Секреты (создаётся вручную по `config.example.env`) |
| `config.example.env`| Пример переменных для `config.env` |
| `travel_wallet.db`  | База SQLite (создаётся при первом запуске) |
| `requirements.txt`  | Зависимости Python |

## API

Используется **только** [api.exchangerate.host](https://exchangerate.host):

- Все запросы на `http://api.exchangerate.host/convert` с параметром `access_key`.
- Дополнительно используется `http://api.exchangerate.host/list` для проверки списка валют (при необходимости).

Ключ хранится в `config.env` (первая переменная — ключ API, вторая — Telegram-токен).

## База данных (SQLite)

- **users** — идентификаторы пользователей Telegram.
- **trips** — путешествия: название, домашняя/валюта поездки, курс, баланс в обеих валютах.
- **expenses** — расходы по поездке (сумма в валюте поездки и в домашней).
- **user_state** — текущее состояние (FSM) и активное путешествие для каждого пользователя.

Каждый пользователь видит только свои путешествия и расходы.

## Ошибки

- Ошибки API (нет ключа, лимит, неверная валюта и т.п.) обрабатываются и выводятся пользователю текстом.
- Нечисловой ввод при ожидании числа, отсутствие активного путешествия, недостаток средств при учёте расхода — обрабатываются с понятными сообщениями.

## Команды и меню

- **/start** — приветствие и главное меню.
- **/newtrip** — создать новое путешествие (то же, что кнопка «Создать новое путешествие»).
- **/switch** — переключить активное путешествие.
- **/balance** — баланс по активному путешествию.
- **/history** — история расходов по активному путешествию.
- **/setrate** — изменить курс для выбранного путешествия.

Главное меню (inline): «Создать новое путешествие», «Мои путешествия», «Баланс», «История расходов», «Изменить курс».
